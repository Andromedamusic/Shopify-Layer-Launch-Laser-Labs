{%- comment -%}
  Back in Stock Notification Signup
  Usage: {% render 'back-in-stock', product: product %}
{%- endcomment -%}

{%- liquid
  assign variant = product.selected_or_first_available_variant
  assign show_form = false

  if variant.available == false
    assign show_form = true
  endif
-%}

{% if show_form %}
  <div class="back-in-stock" id="back-in-stock-{{ product.id }}">
    <div class="back-in-stock__header">
      <svg class="back-in-stock__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
      <h3 class="back-in-stock__title">Notify Me When Available</h3>
    </div>
    <p class="back-in-stock__description">
      Enter your email below and we'll notify you when this item is back in stock.
    </p>
    <form class="back-in-stock__form" data-back-in-stock-form data-product-id="{{ product.id }}" data-variant-id="{{ variant.id }}">
      <div class="back-in-stock__input-group">
        <input
          type="email"
          name="email"
          class="back-in-stock__input"
          placeholder="Enter your email"
          required
          aria-label="Email address for back in stock notification"
        >
        <button type="submit" class="back-in-stock__submit button button--primary">
          <span class="back-in-stock__submit-text">Notify Me</span>
          <span class="back-in-stock__submit-loading" style="display: none;">
            <svg class="back-in-stock__spinner" width="16" height="16" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
            </svg>
          </span>
        </button>
      </div>
      <div class="back-in-stock__message" style="display: none;" role="alert"></div>
    </form>
  </div>
{% endif %}

<style>
  .back-in-stock {
    padding: 20px;
    background: #f8f8f8;
    border-radius: 8px;
    margin: 1.5rem 0;
  }

  .back-in-stock__header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .back-in-stock__icon {
    color: #c9a227;
  }

  .back-in-stock__title {
    font-size: 1.6rem;
    font-weight: 600;
    margin: 0;
    color: #1a1a1a;
  }

  .back-in-stock__description {
    font-size: 1.4rem;
    color: #666;
    margin: 0 0 1rem;
  }

  .back-in-stock__input-group {
    display: flex;
    gap: 10px;
  }

  @media (max-width: 575px) {
    .back-in-stock__input-group {
      flex-direction: column;
    }
  }

  .back-in-stock__input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1.5rem;
    transition: border-color 0.2s;
  }

  .back-in-stock__input:focus {
    outline: none;
    border-color: #c9a227;
    box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.15);
  }

  .back-in-stock__submit {
    white-space: nowrap;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .back-in-stock__spinner {
    animation: spin 1s linear infinite;
  }

  /* spin animation defined in animations.css */

  .back-in-stock__message {
    margin-top: 12px;
    padding: 10px 14px;
    border-radius: 4px;
    font-size: 1.4rem;
  }

  .back-in-stock__message--success {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
  }

  .back-in-stock__message--error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
  }

  /* Dark mode */
  @media (prefers-color-scheme: dark) {
    .back-in-stock {
      background: #252525;
    }

    .back-in-stock__title {
      color: #f5f5f5;
    }

    .back-in-stock__description {
      color: #b0b0b0;
    }

    .back-in-stock__input {
      background: #333;
      border-color: #404040;
      color: #f5f5f5;
    }

    .back-in-stock__input:focus {
      border-color: #c9a227;
      box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.2);
    }

    .back-in-stock__message--success {
      background: #1b5e20;
      color: #a5d6a7;
      border-color: #388e3c;
    }

    .back-in-stock__message--error {
      background: #b71c1c;
      color: #ef9a9a;
      border-color: #c62828;
    }
  }
</style>

<script>
(function() {
  // Back in Stock form handler
  document.addEventListener('submit', function(e) {
    const form = e.target;
    if (!form.matches('[data-back-in-stock-form]')) return;

    e.preventDefault();

    const email = form.querySelector('input[name="email"]').value;
    const productId = form.dataset.productId;
    const variantId = form.dataset.variantId;
    const submitBtn = form.querySelector('.back-in-stock__submit');
    const submitText = form.querySelector('.back-in-stock__submit-text');
    const submitLoading = form.querySelector('.back-in-stock__submit-loading');
    const messageEl = form.querySelector('.back-in-stock__message');

    // Show loading state
    submitBtn.disabled = true;
    submitText.style.display = 'none';
    submitLoading.style.display = 'block';

    // Store notification request locally
    // In production, you'd send this to a back-in-stock service API
    try {
      const notifications = JSON.parse(localStorage.getItem('llll_back_in_stock') || '[]');

      // Check if already subscribed
      const exists = notifications.some(n => n.email === email && n.variantId === variantId);

      if (exists) {
        showMessage(messageEl, 'You\'re already on the notification list!', 'success');
      } else {
        notifications.push({
          email: email,
          productId: productId,
          variantId: variantId,
          timestamp: Date.now()
        });
        localStorage.setItem('llll_back_in_stock', JSON.stringify(notifications));
        showMessage(messageEl, 'Thanks! We\'ll notify you when this item is back in stock.', 'success');
        form.querySelector('input[name="email"]').value = '';
      }
    } catch (error) {
      console.error('Error saving notification:', error);
      showMessage(messageEl, 'Sorry, something went wrong. Please try again.', 'error');
    }

    // Reset button state
    submitBtn.disabled = false;
    submitText.style.display = 'block';
    submitLoading.style.display = 'none';
  });

  function showMessage(el, text, type) {
    el.textContent = text;
    el.className = 'back-in-stock__message back-in-stock__message--' + type;
    el.style.display = 'block';

    // Auto-hide after 5 seconds
    setTimeout(() => {
      el.style.display = 'none';
    }, 5000);
  }
})();
</script>
