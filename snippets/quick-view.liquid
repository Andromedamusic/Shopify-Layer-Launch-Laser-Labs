{%- comment -%}
  Quick View Modal for collection pages
  Usage: Add quick view button to product cards
{%- endcomment -%}

<div id="quick-view-modal" class="quick-view-modal" aria-hidden="true">
  <div class="quick-view-modal__overlay" data-quick-view-close></div>
  <div class="quick-view-modal__content" role="dialog" aria-modal="true" aria-labelledby="quick-view-title">
    <button class="quick-view-modal__close" data-quick-view-close aria-label="Close quick view">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>

    <div class="quick-view-modal__body" id="quick-view-body">
      <div class="quick-view-modal__loading">
        <div class="quick-view-modal__spinner"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .quick-view-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    visibility: hidden;
    padding: 20px;
  }

  .quick-view-modal.is-open {
    pointer-events: auto;
    visibility: visible;
  }

  .quick-view-modal__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .quick-view-modal.is-open .quick-view-modal__overlay {
    opacity: 1;
  }

  .quick-view-modal__content {
    position: relative;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    transform: scale(0.95) translateY(20px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .quick-view-modal.is-open .quick-view-modal__content {
    transform: scale(1) translateY(0);
    opacity: 1;
  }

  .quick-view-modal__close {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 10;
    background: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: background 0.2s, transform 0.2s;
  }

  .quick-view-modal__close:hover {
    background: #f5f5f5;
    transform: scale(1.05);
  }

  .quick-view-modal__body {
    max-height: 90vh;
    overflow-y: auto;
  }

  .quick-view-modal__loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 80px;
  }

  .quick-view-modal__spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #eee;
    border-top-color: #c9a227;
    border-radius: 50%;
    animation: qv-spin 0.8s linear infinite;
  }

  @keyframes qv-spin {
    to { transform: rotate(360deg); }
  }

  /* Quick View Product Layout */
  .quick-view-product {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }

  @media (max-width: 749px) {
    .quick-view-product {
      grid-template-columns: 1fr;
    }
  }

  .quick-view-product__gallery {
    background: #f8f8f8;
    padding: 20px;
  }

  .quick-view-product__image {
    width: 100%;
    height: auto;
    border-radius: 8px;
  }

  .quick-view-product__thumbnails {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    overflow-x: auto;
  }

  .quick-view-product__thumb {
    width: 60px;
    height: 60px;
    border: 2px solid transparent;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    flex-shrink: 0;
  }

  .quick-view-product__thumb.active {
    border-color: #1a1a1a;
  }

  .quick-view-product__thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .quick-view-product__info {
    padding: 30px;
    display: flex;
    flex-direction: column;
  }

  .quick-view-product__title {
    font-size: 2.2rem;
    margin: 0 0 0.5rem;
    padding-right: 40px;
  }

  .quick-view-product__vendor {
    font-size: 1.4rem;
    color: #666;
    margin-bottom: 1rem;
  }

  .quick-view-product__price {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .quick-view-product__price-compare {
    font-size: 1.5rem;
    color: #999;
    text-decoration: line-through;
    margin-right: 0.5rem;
    font-weight: 400;
  }

  .quick-view-product__description {
    font-size: 1.5rem;
    color: #666;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    max-height: 100px;
    overflow-y: auto;
  }

  .quick-view-product__form {
    margin-top: auto;
  }

  .quick-view-product__variants {
    margin-bottom: 1rem;
  }

  .quick-view-product__variant-label {
    display: block;
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .quick-view-product__variant-select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1.5rem;
  }

  .quick-view-product__quantity {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .quick-view-product__qty-label {
    font-size: 1.4rem;
    font-weight: 600;
  }

  .quick-view-product__qty-wrapper {
    display: flex;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
  }

  .quick-view-product__qty-btn {
    width: 40px;
    height: 40px;
    background: #f8f8f8;
    border: none;
    cursor: pointer;
    font-size: 1.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .quick-view-product__qty-btn:hover {
    background: #eee;
  }

  .quick-view-product__qty-input {
    width: 50px;
    height: 40px;
    border: none;
    text-align: center;
    font-size: 1.5rem;
    -moz-appearance: textfield;
  }

  .quick-view-product__qty-input::-webkit-outer-spin-button,
  .quick-view-product__qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
  }

  .quick-view-product__add-btn {
    width: 100%;
    padding: 14px 24px;
    margin-bottom: 1rem;
  }

  .quick-view-product__view-full {
    display: block;
    text-align: center;
    font-size: 1.4rem;
    color: #666;
  }

  .quick-view-product__view-full:hover {
    color: #c9a227;
  }

  /* Quick View Button for Product Cards */
  .quick-view-btn {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    background: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 1.3rem;
    font-weight: 600;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s, transform 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    white-space: nowrap;
  }

  .product-card:hover .quick-view-btn {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .quick-view-btn:hover {
    background: #1a1a1a;
    color: white;
  }
</style>

<script>
(function() {
  const modal = document.getElementById('quick-view-modal');
  const body = document.getElementById('quick-view-body');

  if (!modal || !body) return;

  // Open quick view
  window.openQuickView = async function(productHandle) {
    modal.classList.add('is-open');
    document.body.style.overflow = 'hidden';
    modal.setAttribute('aria-hidden', 'false');

    // Show loading state
    body.innerHTML = `
      <div class="quick-view-modal__loading">
        <div class="quick-view-modal__spinner"></div>
      </div>
    `;

    try {
      // Fetch product data
      const response = await fetch(`/products/${productHandle}.js`);
      const product = await response.json();

      renderQuickView(product);
    } catch (error) {
      console.error('Error loading quick view:', error);
      body.innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <p>Sorry, we couldn't load this product.</p>
          <a href="/products/${productHandle}" class="button button--primary">View Product</a>
        </div>
      `;
    }
  };

  // Render quick view content
  function renderQuickView(product) {
    const variant = product.variants[0];
    const hasMultipleVariants = product.variants.length > 1;
    const hasComparePrice = variant.compare_at_price && variant.compare_at_price > variant.price;

    body.innerHTML = `
      <div class="quick-view-product">
        <div class="quick-view-product__gallery">
          <img
            src="${product.featured_image}"
            alt="${product.title}"
            class="quick-view-product__image"
            id="qv-main-image"
          >
          ${product.images.length > 1 ? `
            <div class="quick-view-product__thumbnails">
              ${product.images.map((img, i) => `
                <button class="quick-view-product__thumb ${i === 0 ? 'active' : ''}" data-image="${img}">
                  <img src="${img.replace(/(\.[^.]+)$/, '_100x100$1')}" alt="${product.title}">
                </button>
              `).join('')}
            </div>
          ` : ''}
        </div>
        <div class="quick-view-product__info">
          <h2 class="quick-view-product__title" id="quick-view-title">${product.title}</h2>
          ${product.vendor ? `<p class="quick-view-product__vendor">${product.vendor}</p>` : ''}
          <p class="quick-view-product__price">
            ${hasComparePrice ? `<span class="quick-view-product__price-compare">${formatMoney(variant.compare_at_price)}</span>` : ''}
            <span id="qv-price">${formatMoney(variant.price)}</span>
          </p>
          <div class="quick-view-product__description">
            ${product.description ? stripHtml(product.description).substring(0, 200) + '...' : ''}
          </div>
          <form class="quick-view-product__form" action="/cart/add" method="post">
            ${hasMultipleVariants ? `
              <div class="quick-view-product__variants">
                ${product.options.map((option, i) => `
                  <div style="margin-bottom: 0.75rem;">
                    <label class="quick-view-product__variant-label">${option}</label>
                    <select class="quick-view-product__variant-select" data-option-index="${i}">
                      ${[...new Set(product.variants.map(v => v.options[i]))].map(value => `
                        <option value="${value}">${value}</option>
                      `).join('')}
                    </select>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            <input type="hidden" name="id" value="${variant.id}" id="qv-variant-id">
            <div class="quick-view-product__quantity">
              <span class="quick-view-product__qty-label">Quantity:</span>
              <div class="quick-view-product__qty-wrapper">
                <button type="button" class="quick-view-product__qty-btn" data-action="decrease">−</button>
                <input type="number" name="quantity" value="1" min="1" max="99" class="quick-view-product__qty-input" id="qv-quantity">
                <button type="button" class="quick-view-product__qty-btn" data-action="increase">+</button>
              </div>
            </div>
            <button type="submit" class="quick-view-product__add-btn button button--primary">
              Add to Cart
            </button>
          </form>
          <a href="${product.url}" class="quick-view-product__view-full">View Full Details →</a>
        </div>
      </div>
    `;

    // Attach event listeners
    attachQuickViewListeners(product);
  }

  // Attach event listeners for quick view
  function attachQuickViewListeners(product) {
    // Thumbnail clicks
    body.querySelectorAll('.quick-view-product__thumb').forEach(thumb => {
      thumb.addEventListener('click', () => {
        body.querySelectorAll('.quick-view-product__thumb').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
        body.querySelector('#qv-main-image').src = thumb.dataset.image;
      });
    });

    // Variant selection
    const variantSelects = body.querySelectorAll('.quick-view-product__variant-select');
    variantSelects.forEach(select => {
      select.addEventListener('change', () => {
        const selectedOptions = Array.from(variantSelects).map(s => s.value);
        const variant = product.variants.find(v =>
          v.options.every((opt, i) => opt === selectedOptions[i])
        );
        if (variant) {
          body.querySelector('#qv-variant-id').value = variant.id;
          body.querySelector('#qv-price').textContent = formatMoney(variant.price);
        }
      });
    });

    // Quantity buttons
    body.querySelectorAll('.quick-view-product__qty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const input = body.querySelector('#qv-quantity');
        const current = parseInt(input.value) || 1;
        if (btn.dataset.action === 'increase' && current < 99) {
          input.value = current + 1;
        } else if (btn.dataset.action === 'decrease' && current > 1) {
          input.value = current - 1;
        }
      });
    });

    // Form submission
    const form = body.querySelector('.quick-view-product__form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const submitBtn = form.querySelector('.quick-view-product__add-btn');

        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';

        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            submitBtn.textContent = 'Added!';
            setTimeout(() => {
              closeQuickView();
              if (window.openCartDrawer) window.openCartDrawer();
            }, 500);
          } else {
            const data = await response.json();
            alert(data.description || 'Could not add to cart');
            submitBtn.textContent = 'Add to Cart';
            submitBtn.disabled = false;
          }
        } catch (error) {
          console.error('Error:', error);
          submitBtn.textContent = 'Add to Cart';
          submitBtn.disabled = false;
        }
      });
    }
  }

  // Close quick view
  window.closeQuickView = function() {
    modal.classList.remove('is-open');
    document.body.style.overflow = '';
    modal.setAttribute('aria-hidden', 'true');
  };

  // Close button handlers
  modal.querySelectorAll('[data-quick-view-close]').forEach(el => {
    el.addEventListener('click', closeQuickView);
  });

  // Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('is-open')) {
      closeQuickView();
    }
  });

  // Helper: Format money
  function formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  // Helper: Strip HTML
  function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }

  // Quick view button clicks
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-quick-view]');
    if (btn) {
      e.preventDefault();
      openQuickView(btn.dataset.quickView);
    }
  });
})();
</script>
