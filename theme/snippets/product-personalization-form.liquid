{%- comment -%}
  Product Personalization Form Snippet
  Include in product templates to add personalization fields.

  Usage:
  {% render 'product-personalization-form', product: product %}

  Personalization data is captured as line item properties and
  appears in the order details for fulfillment.
{%- endcomment -%}

{% assign personalization_type = product.metafields.custom.personalization_type | default: 'text' %}
{% assign max_lines = product.metafields.custom.max_engraving_lines | default: 2 %}
{% assign max_chars = product.metafields.custom.max_chars_per_line | default: 25 %}
{% assign requires_upload = product.metafields.custom.requires_upload | default: false %}

<div class="product-personalization">
  <div class="product-personalization__header">
    <h3 class="product-personalization__title">Personalize Your Item</h3>
    <p class="product-personalization__help">{{ settings.personalization_help_text | default: 'Enter your custom engraving text below.' }}</p>
  </div>

  {% case personalization_type %}
    {% when 'text' %}
      {%- comment -%} Text-only personalization {%- endcomment -%}
      <div class="product-personalization__fields">
        {% for i in (1..max_lines) %}
          <div class="product-personalization__field">
            <label for="engraving-line-{{ i }}" class="product-personalization__label">
              Line {{ i }}
              {% if i == 1 %}<span class="required">*</span>{% endif %}
            </label>
            <input
              type="text"
              id="engraving-line-{{ i }}"
              name="properties[Engraving Line {{ i }}]"
              maxlength="{{ max_chars }}"
              class="product-personalization__input"
              placeholder="Enter text (max {{ max_chars }} characters)"
              {% if i == 1 %}required{% endif %}
            >
            <span class="product-personalization__char-count">
              <span class="current">0</span>/{{ max_chars }}
            </span>
          </div>
        {% endfor %}

        <div class="product-personalization__field">
          <label for="font-style" class="product-personalization__label">Font Style</label>
          <select id="font-style" name="properties[Font Style]" class="product-personalization__select">
            <option value="Script">Script (Elegant)</option>
            <option value="Block">Block (Bold)</option>
            <option value="Modern">Modern (Clean)</option>
            <option value="Serif">Serif (Classic)</option>
          </select>
        </div>
      </div>

    {% when 'photo' %}
      {%- comment -%} Photo engraving - upload after purchase {%- endcomment -%}
      <div class="product-personalization__photo-notice">
        <div class="product-personalization__notice-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
        </div>
        <div class="product-personalization__notice-content">
          <strong>Photo Engraving Product</strong>
          <p>After completing your purchase, you'll upload your photo on our <a href="{{ settings.upload_page_url | default: '/pages/custom-upload' }}">Custom Upload page</a>. We'll send a proof for your approval before production.</p>
        </div>
      </div>

      <input type="hidden" name="properties[_Requires Photo Upload]" value="Yes">

      <div class="product-personalization__field">
        <label for="photo-notes" class="product-personalization__label">Photo Notes (optional)</label>
        <textarea
          id="photo-notes"
          name="properties[Photo Notes]"
          class="product-personalization__textarea"
          placeholder="Any special instructions for your photo (e.g., crop preferences, specific area to focus on)"
          rows="3"
        ></textarea>
      </div>

    {% when 'logo' %}
      {%- comment -%} Logo engraving - upload after purchase {%- endcomment -%}
      <div class="product-personalization__photo-notice">
        <div class="product-personalization__notice-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
        </div>
        <div class="product-personalization__notice-content">
          <strong>Logo Engraving Product</strong>
          <p>After completing your purchase, upload your logo file on our <a href="{{ settings.upload_page_url | default: '/pages/custom-upload' }}">Custom Upload page</a>. We accept PNG, JPG, PDF, AI, and SVG files.</p>
        </div>
      </div>

      <input type="hidden" name="properties[_Requires Logo Upload]" value="Yes">

      <div class="product-personalization__field">
        <label for="company-name" class="product-personalization__label">Company/Organization Name</label>
        <input
          type="text"
          id="company-name"
          name="properties[Company Name]"
          class="product-personalization__input"
          placeholder="Enter company or organization name"
        >
      </div>

    {% when 'design_library' %}
      {%- comment -%} Design from library selection {%- endcomment -%}
      <div class="product-personalization__field">
        <label for="design-selection" class="product-personalization__label">
          Selected Design <span class="required">*</span>
        </label>
        <input
          type="text"
          id="design-selection"
          name="properties[Design Selection]"
          class="product-personalization__input"
          placeholder="Enter design name from our library"
          required
        >
        <a href="{{ settings.library_url | default: '/pages/design-library' }}" class="product-personalization__library-link" target="_blank">
          Browse Design Library â†’
        </a>
      </div>

      <div class="product-personalization__field">
        <label for="design-customization" class="product-personalization__label">Customization (optional)</label>
        <textarea
          id="design-customization"
          name="properties[Design Customization]"
          class="product-personalization__textarea"
          placeholder="Any personalization to add to the design (e.g., name, date, location)"
          rows="2"
        ></textarea>
      </div>

    {% else %}
      {%- comment -%} Default: text personalization {%- endcomment -%}
      <div class="product-personalization__fields">
        <div class="product-personalization__field">
          <label for="engraving-text" class="product-personalization__label">
            Engraving Text <span class="required">*</span>
          </label>
          <input
            type="text"
            id="engraving-text"
            name="properties[Engraving Text]"
            maxlength="50"
            class="product-personalization__input"
            placeholder="Enter your personalization text"
            required
          >
        </div>
      </div>
  {% endcase %}

  {%- comment -%} Special Instructions (always shown) {%- endcomment -%}
  <div class="product-personalization__field product-personalization__field--notes">
    <label for="special-instructions" class="product-personalization__label">Special Instructions (optional)</label>
    <textarea
      id="special-instructions"
      name="properties[Special Instructions]"
      class="product-personalization__textarea"
      placeholder="Any additional notes for your order"
      rows="2"
    ></textarea>
  </div>
</div>

<style>
  .product-personalization {
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: #f9f9f9;
    border-radius: 8px;
  }
  .product-personalization__header {
    margin-bottom: 1.25rem;
  }
  .product-personalization__title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
  }
  .product-personalization__help {
    font-size: 0.875rem;
    color: rgba(0,0,0,0.6);
    margin: 0;
  }
  .product-personalization__fields {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .product-personalization__field {
    position: relative;
  }
  .product-personalization__field--notes {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(0,0,0,0.1);
  }
  .product-personalization__label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
  .product-personalization__label .required {
    color: #c62828;
  }
  .product-personalization__input,
  .product-personalization__select,
  .product-personalization__textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
  }
  .product-personalization__input:focus,
  .product-personalization__select:focus,
  .product-personalization__textarea:focus {
    outline: none;
    border-color: #1a1a1a;
  }
  .product-personalization__char-count {
    position: absolute;
    right: 0.75rem;
    bottom: 0.75rem;
    font-size: 0.75rem;
    color: rgba(0,0,0,0.4);
    pointer-events: none;
  }
  .product-personalization__photo-notice {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: #fff3cd;
    border-radius: 6px;
    margin-bottom: 1rem;
  }
  .product-personalization__notice-icon {
    flex-shrink: 0;
    color: #856404;
  }
  .product-personalization__notice-content {
    font-size: 0.875rem;
  }
  .product-personalization__notice-content strong {
    display: block;
    margin-bottom: 0.25rem;
    color: #856404;
  }
  .product-personalization__notice-content p {
    margin: 0;
    color: #856404;
  }
  .product-personalization__notice-content a {
    color: #856404;
    text-decoration: underline;
  }
  .product-personalization__library-link {
    display: inline-block;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #1a1a1a;
  }
</style>

<script>
  // Character counter for text inputs
  document.querySelectorAll('.product-personalization__input[maxlength]').forEach(input => {
    const counter = input.parentElement.querySelector('.product-personalization__char-count .current');
    if (counter) {
      input.addEventListener('input', () => {
        counter.textContent = input.value.length;
      });
    }
  });
</script>
